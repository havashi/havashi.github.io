---
layout: default
---
{% assign orgPost = site.posts | where: 'slug', page.postSlug | first %}
{% assign cas = site.cases | where: 'slug', page.case | first %}
    <div class="user container pt-3">
      <div class="row mt-5">
        <h3 class="mt-5 text-secondary">پیشنهاد {% if orgPost %}ویرایش صفحه{% else%}صفحه جدید{% endif %}</h3>
      </div>
      <div class="row">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a class="black-text" href="/"><i class="fas fa-home"></i></a></li>
            <li class="breadcrumb-item"><a class="black-text" href="{{cas.url}}">{{cas.title}}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{% if orgPost %}{{orgPost.title}}{% else%}{{page.title}}{% endif %}</li>
          </ol>
        </nav>
      </div>
        <!--Add few elements to the form-->
        <form id="editPost" action="/" method="post" data-action="draftPublish">
          <div class="row">
            <div class="col form-group">
              <label for="title">عنوان</label>
              {% if orgPost %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" name="title" aria-label="Radio button for following text input">
                  </div>
                </div>
                <input type="text" class="form-control" disabled value="{{orgPost.title}}">
              </div>
              {% endif %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" name="title" checked aria-label="Radio button for following text input">
                  </div>
                </div>
                <input type="text" class="form-control" value="{{page.title}}">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col form-group">
              <label for="startDate">از تاریخ</label>
              {% if orgPost %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" class="orgPost" name="startDate" aria-label="Radio button for following text input">
                  </div>
                </div>
                <input type="text" class="form-control" disabled value="{{orgPost.startDate}}">
                <input type="hidden" name="" value="">
              </div>
              {% endif %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" name="startDate" checked aria-label="Radio button for following text input">
                  </div>
                </div>
                <input type="text" id="startDate" class="form-control" value="">
                <input type="hidden" id="startDateU"  value=""/>
              </div>
            </div>
            <div class="col form-group">
              <label for="endDate">تا تاریخ</label>
              {% if orgPost %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" class="orgPost" name="endDate" aria-label="Radio button for following text input">
                  </div>
                </div>
                <input type="text" class="form-control" disabled value="{{orgPost.startDate}}">
                <input type="hidden" name="" value="">
              </div>
              {% endif %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" name="endDate" checked aria-label="Radio button for following text input">
                  </div>
                </div>
                <input type="text" id="endDate" class="form-control converUNIX" value="">
                <input type="hidden" id="endDateU" />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col form-group">
              <label for="text">توضیح</label>
              {% if orgPost %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" class="orgPost" name="text" aria-label="Radio button for following text input">
                  </div>
                </div>
                <textarea class="form-control" disabled style="height:100px">{{orgPost.content | strip_html | strip_newlines}}</textarea>
              </div>
              {% endif %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" name="text" checked aria-label="Radio button for following text input">
                  </div>
                </div>
                <textarea class="form-control" style="height:100px">{{page.content | strip_html | strip_newlines}}</textarea>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <label>فایل پیوست</label>
              {% if orgPost %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" class="orgPost" name="mediaFile" aria-label="Radio button for following text input">
                  </div>
                  <select class="form-control mediaType" disabled>
                    <option {% unless orgPost.mediaType %}selected='selected'{% endunless %} value=""></option>
                    <option {% if orgPost.mediaType == 'image' %} selected='selected' {% endif %} value="image">عکس</option>
                    <option {% if orgPost.mediaType == 'video' %} selected='selected' {% endif %} value="video">ویدئو</option>
                    <option {% if orgPost.mediaType == 'audio' %} selected='selected' {% endif %} value="audio">فایل صوتی</option>
                  </select>
                </div>
                <div class="input-group-append">
                  <a href="{{orgPost.media}}"  data-path="{{orgPost.media}}" class="image-link btn btn-success btn-sm" target="_blank" {% unless orgPost.media %} style="display: none;" {% endunless %}>نمایش</a>
                </div>
              </div>
              {% endif %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" name="mediaFile" checked aria-label="Radio button for following text input">
                  </div>
                  <select class="form-control mediaType">
                    <option value="">نوع فایل ...</option>
                    <option {% if page.mediaType == 'image' %} selected='selected' {% endif %} value="image">عکس</option>
                    <option {% if page.mediaType == 'video' %} selected='selected' {% endif %} value="video">ویدئو</option>
                    <option {% if page.mediaType == 'audio' %} selected='selected' {% endif %} value="audio">فایل صوتی</option>
                  </select>
                </div>
                <div class="upload custom-file uploadImg">
                  <input type="file" class="uploadImg custom-file-input" id="file">
                  <label class="custom-file-label" for="file">Choose file</label>
                </div>
                <div class="upload input-group-append git">
                  <a href="javascript:void(0)" class="uploadGit uploadImg btn btn-secondary btn-sm" id="uploadFImg" data-commit="upload post feature media" data-path="assets/cases/{{page.case}}/" data-name="{{page.slug}}" {% if page.media %} style="display: none;" {% endif %}><span class="spinner-border spinner-border-sm" style="display:none;"></span> بارگذاری</a>
                  <a href="{{page.media}}" class="image-link uploadedImg btn btn-success btn-sm" target="_blank" {% unless page.media %} style="display: none;" {% endunless %} data-path="{{page.media}}">نمایش</a>
                  <a href="javascript:void(0)" class="image-delete uploadedImg btn btn-danger btn-sm" {% unless page.media %} style="display: none;" {% endunless %}>حذف</a>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
              <div class="form-group">
                <label for="mediaCaption">توضیح فایل پیوست</label>
                {% if orgPost %}
                <div class="input-group">
                  <div class="input-group-prepend">
                    <div class="input-group-text">
                    <input type="radio" class="orgPost" name="mediaCaption" aria-label="Radio button for following text input">
                    </div>
                  </div>
                  <input type="text" class="form-control" disabled value="{{orgPost.mediaCaption}}">
                </div>
                {% endif %}
                <div class="input-group">
                  <div class="input-group-prepend">
                    <div class="input-group-text">
                    <input type="radio" name="mediaCaption" checked aria-label="Radio button for following text input">
                    </div>
                  </div>
                  <input type="text" class="form-control" value="{{page.mediaCaption}}">
                </div>
              </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
              <label for="mediaCaptionUrl">منبع فایل پیوست</label>
              {% if orgPost %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" class="orgPost" name="mediaCaptionUrl" aria-label="Radio button for following text input">
                  </div>
                </div>
                <input type="text" class="form-control" disabled value="{{orgPost.mediaCaptionUrl}}" lang="en" dir="ltr" >
              </div>
              {% endif %}
              <div class="input-group">
                <div class="input-group-prepend">
                  <div class="input-group-text">
                  <input type="radio" name="mediaCaptionUrl" checked aria-label="Radio button for following text input">
                  </div>
                </div>
                <input type="text" class="form-control" value="{{page.mediaCaptionUrl}}" lang="en" dir="ltr" >
              </div>
            </div>
          </div>
          <div class="row guest">
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
              <div class="form-group">
                <label for="guestName">نام و نام خانوادگی</label>
                <input type="text" class="form-control" name="guestName" id="guestName" value="{{page.guestName}}" required>
              </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
              <div class="form-group">
                <label for="guestEmail">ایمیل</label>
                <input type="email" class="form-control" name="guestEmail" id="guestEmail" value="{{page.guestEmail}}" required>
              </div>
            </div>
          </div>
          <div class="row admin editor bg-light p-2">
            <h3>تنظیمات ویراستاری</h3>
          </div>
          <div class="row admin bg-light">
            <div class="col-3 form-group">
              <label for="tag">برچسب</label>
              <input type="text" class="form-control" id="tag" value="{{page.tag}}" placeholder="بازیگر این صفحه از روایت ..." />
            </div>
            <div class="col-3">
              <label for="txtCase">Case</label>
              <input type="text" lang="en" dir="ltr" class="form-control" value="{{page.case}}" id="txtCase" placeholder="case..." value="{{page.slug}}"/>
            </div>
            <div class="col-3">
              <label for="txtSlug" dir="ltr" >ُSlug</label>
              <input type="text" lang="en" dir="ltr" class="form-control" id="txtSlug" value="{{page.postSlug}}" placeholder="slug..." />
            </div>
            <div class="col-3 form-group">
              <label for="tag">اقدام</label>
              <select class="form-control" name="action">
                <option value="Save">ذخیره</option>
                <option value="Publish">انتشار</option>
              </select>
            </div>
          </div>
          <a href="javascript:void(0)" class="gitMdUpload">save</a>
          <div class="row mt-2">
            <div class="col">
                <button type="submit" id="bt" value="Submit" class="btn btn-primary btn-lg btn-block"><span class="spinner-border" style="display:none;"></span> <span id="submitTxt">Save</span></button>
            </div>
        </div>
      </form>
    </div>
<script type="text/javascript">
  $('select[name=action]').change(function () {
    $('#submitTxt').text($(this).val())
  });
  $('#editPost').submit(function (event) {
    event.preventDefault();
  });
function afterLogin(user) {
  $(document).ready(function () {
    $('.mediaType').change(function () {
      if ($(this).val() == 'image') {
        $('.upload').show();
        $('#file').attr('accept', 'image/*');
      } else if ($(this).val() == 'video') {
        $('.upload').show();
        $('#file').attr('accept', 'video/*');
      } else if ($(this).val() == 'audio') {
        $('.upload').show();
        $('#file').attr('accept', 'audio/*');
      } else {
        $('.upload').hide();
      }
    });
    $('.mediaType').trigger('change');
    var orgPostStartDateU = new persianDate([{{orgPost.startDate}}]);
    $($('input[name=startDate].orgPost').closest('.input-group').find("input[type=hidden]")).val(orgPostStartDateU.format('X')+'000')
    var orgPostEndDateU = new persianDate([{{orgPost.startDate}}]);
    $($('input[name=endDate].orgPost').closest('.input-group').find("input[type=hidden]")).val(orgPostEndDateU.format('X')+'000')
    $('.image-delete').click(function () {
      $(this).hide();
      $('.uploadImg').show();
      $(this).siblings('.uploadedImg').hide();
      $(this).siblings('.btn-success').attr('href', '');
    })
    {% if page.media %}
      $('.uploadedImg').show();
      $('.uploadImg').hide();
    {% else %}
    $('.uploadedImg').hide();
    $('.uploadImg').show();
    {% endif %}
    var to, from;
  to = $("#endDate").persianDatepicker({
    initialValue: false,
    responsive: true,
    format: 'L',
    autoClose: true,
    altField: '#endDateU',
    calendar:{
      persian:{
        showHint: true
      },
      gregorian:{
        showHint: true
      }
    },
    onSelect: function (unix) {
          to.touched = true;
          if (from && from.options && from.options.maxDate != unix) {
              var cachedValue = from.getState().selected.unixDate;
              from.options = {maxDate: unix};
              if (from.touched) {
                  from.setDate(cachedValue);
              }
          }
      }
  });
  from = $("#startDate").persianDatepicker({
    initialValue: false,
    responsive: true,
    format: 'L',
    autoClose: true,
    altField: '#startDateU',
    calendar:{
      persian:{
        showHint: true
      },
      gregorian:{
        showHint: true
      }
    },
    onSelect: function (unix) {
          from.touched = true;
          if (to && to.options && to.options.minDate != unix) {
              to.options = {minDate: unix};
              to.setDate(unix);
          }
      }
  });
  var fromDate = new persianDate([{{page.startDate}}]);
  var toDate = new persianDate([{{page.endDate}}]);
  from.setDate(fromDate);
  to.setDate(toDate);
  })
  $('#editPost').submit(function (event) {
    event.preventDefault();
    var submitBtn = $('button[type=submit]');
    submitBtn.children('span').show();
    submitBtn.attr('disabled', true);
    if ($('select[name=action]').val() == 'Publish') {
      var draftPublish = 1;
    } else {
      var draftPublish = 0;
    }
    var title = $($('input[name=title]:checked').closest('.input-group').find("input[type=text]")).val();
    var text = $($('input[name=text]:checked').closest('.input-group').find("textarea")).html();
    var startDateU = $($('input[name=startDate]:checked').closest('.input-group').find("input[type=hidden]")).val();
    var endDateU = $($('input[name=endDate]:checked').closest('.input-group').find("input[type=hidden]")).val();
    var mediaType = $($('input[name=mediaFile]:checked').closest('.input-group').find("select")).val();
    var media = $($('input[name=mediaFile]:checked').closest('.input-group').find(".image-link")).attr('data-path');
    var mediaCaption = $($('input[name=mediaCaption]:checked').closest('.input-group').find("input[type=text]")).val();
    var mediaCaptionUrl = $($('input[name=mediaCaptionUrl]:checked').closest('.input-group').find("input[type=text]")).val();
    var guestEmail = $('#guestEmail').val();
    var guestSlug = guestEmail.split("@")[0];
    var editDate= Date.now();
    editDate = editDate.toString().slice(0,-3);
    var draftPath = '_drafts/';
    var postPath = '_posts/';
    var draftSlug = '{{page.slug}}';
    var endDateFa = new persianDate(parseInt(endDateU));
    endDateFa.formatPersian = false;
    var startDateFa = new persianDate(parseInt(startDateU));
    startDateFa.formatPersian = false;
    var startDateEn = new Date(parseInt(startDateU));
    var draft =
          '--- \r\n'  +
          'case: ' + $('#txtCase').val() + ' \r\n' +
          'title: ' +title + ' \r\n' +
          'slug: ' +draftSlug + ' \r\n' +
          'startDate: "' + startDateFa.format("YYYY,MM,DD") + '" \r\n' +
          'endDate: "' + endDateFa.format("YYYY,MM,DD")  + '" \r\n' +
          'tag: ' + $('#tag').val() + ' \r\n' +
          'mediaType: ' + mediaType + ' \r\n' +
          'media: ' + media + ' \r\n' +
          'mediaCaption: ' + mediaCaption + ' \r\n' +
          'mediaCaptionUrl: ' + mediaCaptionUrl + ' \r\n' +
          'guestName: ' + $('#guestName').val() + ' \r\n' +
          'guestEmail: ' + $('#guestEmail').val() + ' \r\n' +
          'editDate: ' + editDate + ' \r\n' +
          'postSlug: ' + $('#txtSlug').val() + ' \r\n' +
          'draftPublish: ' + draftPublish + ' \r\n' +
          '---'+ '\r\n' +
          text;
    var post =
          '--- \r\n'  +
          'case: ' + $('#txtCase').val() + ' \r\n' +
          'title: ' +title + ' \r\n' +
          'slug: ' +$('#txtSlug').val() + ' \r\n' +
          'startDate: "' + startDateFa.format("YYYY,MM,DD") + '" \r\n' +
          'endDate: "' + endDateFa.format("YYYY,MM,DD")  + '" \r\n' +
          'tag: ' + $('#tag').val() + ' \r\n' +
          'mediaType: ' + mediaType + ' \r\n' +
          'media: ' + media + ' \r\n' +
          'mediaCaption: ' + mediaCaption + ' \r\n' +
          'mediaCaptionUrl: ' + mediaCaptionUrl + ' \r\n' +
          '---'+ '\r\n' +
          text;
          var postFileName = startDateEn.toISOString().split("T")[0]+'-'+$('#txtSlug').val()+'.md';	   // The file to save the data.
          var postFilepath = postPath+postFileName;
          var draftFileName = startDateEn.toISOString().split("T")[0]+'-'+draftSlug+'.md';	   // The file to save the data.
          var draftFilepath = draftPath+draftFileName;
          if ($('select[name=action]').val() == 'Publish') {
            saveMarkdown(post, postFileName, postFilepath);
            saveMarkdown(draft, draftFileName, draftFilepath);
          } else {
            $(document).ready(function () {
              $('.gitMdUpload').data('md', {file: draft, name: draftFileName, path: draftFilepath}).trigger('click');
            })
          }
  })
}
function afterSaveMd() {
  submitBtn.children('span').hide();
  submitBtn.attr('disabled', false);
}
function afterFailMd(err) {
  console.error(err);
  alert('Something went wrong. Please, try again.');
  submitBtn.children('span').hide();
  submitBtn.attr('disabled', false);
}
function guest() {
  $('.user').append('<div class="alert alert-danger" role="alert">فقط کاربران به این بخش دسترسی دارند.</div>')
}
</script>
